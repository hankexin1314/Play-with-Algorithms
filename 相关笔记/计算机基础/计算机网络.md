# 概述

## 简述各层作用

- **应用层**：通过应用进程的交互为用户提供特定网络应用。比如说DNS提供域名解析服务，HTTP支持万维网应用，SMTP支持邮箱应用。
- **传输层**：两机通信与数据传输，TCP可靠通信，UDP不保证可靠性
- **网络层**：两机通信会经过很多子网和链路，网络层选择合适的路由和交换节点，确保数据及时传送
- **数据链路层**：两机之间数据传输，在链路上传输，提供链路协议
- **物理层**：两机之间比特流的传输提供支持，屏蔽传输介质和物理设备的差异

# 应用层

## 一、协议

### 1. DNS

**作用**：IP和域名地址之间相互转化提供支持，使用UDP

**过程**(以`www.taobao.com`为例)：

- 浏览器输入域名，查找：本机host -> 浏览器缓存 -> 路由器缓存
- 本机向**本地域名服务器**发送查询请求(首先看目标是否也处于同一个本地域名服务器，再看是否在缓存中)
- **本地域名服务器**向**根域名服务器**查询，得到**顶级域名服务器**(.com域名服务器)的IP地址
- **本地域名服务器**向**顶级域名服务器**查询，得到**权限域名服务器**(.taobao域名服务器)的IP地址
- **本地域名服务器**向**权限域名服务器**查询，得到IP
- 写入缓存

### 2. HTTP

#### 长连接短连接

- 实质上是TCP协议的长连接短连接

- HTTP1.0默认使用短连接，也就是客户端和服务器每进行一次HTTP操作，没访问一个web资源（图片，CSS文件）就会建立一次连接
- HTTP1.1起默认使用长连接

#### Cookie和Session

- HTTP协议无状态，无法保存用户状态。例如，我登录了，但是我跳转到下一个链接，HTTP协议无状态，我仍需再次登录
- Session，服务器端保存用户状态。例如，用户登陆成功，服务器向redis中写入一个key和value，key中包含一个Session ID，这个Session ID会返回给客户端，value是用户信息。用户向购物车添加商品(跳转到一个新的页面)，服务器不知道哪个用户在添加商品，但是用户的浏览器带着Cookie，Cookie中带着这个Session ID，服务器一校验，就知道是哪个用户操作了。
- Session在服务器端，保存着数据，Cookie在客户端，仅仅保存Session ID
- 如果禁用Cookie，一般将Session ID附带在URI中

#### URI和URL

URI类似身份证号，URL类似家庭住址。URI唯一标识一个资源，URL用于定位这个资源。

#### 状态码

- 1XX 信息类型，收到请求正在处理
- 2XX 请求成功处理
- 3XX 重定向
- 4XX 服务器无法处理请求
- 5XX 服务器处理请求出错

### 3. HTTPS

- 端口：HTTP开头是 http:// 默认端口80， HTTPS https:// 默认端口443
- 协议：HTTP运行在TCP上，HTTPS运行在SSL/TLS协议上，SSL/TLS运行在TCP上
- 安全性：HTTP传输内容都是明文，客户端和服务器无法互相校验身份。HTTPS，传输的内容进行对称加密(加密解密的密钥相同)，传输使用的密钥又使用服务器上的证书进行非对称加密(加密解密密钥不同，二者无法相互推导)



## 二、浏览一个网页发生了什么

- 域名解析：DNS将域名解析为IP
- 浏览器带着Cookie向Web服务器发送HTTP请求

>TCP**建立连接**，三次握手需要发送数据
>
>使用IP协议发送接收数据，通过ARP协议将IP转化为MAC地址，将**IP数据报**封装为**MAC帧**进行传输
>
>TCP连接建立成功，发送HTTP 请求，服务器处理请求，返回HTTP响应

- 浏览器接收响应，解析渲染页面

# 传输层

为两机之间的进程通信提供传输服务。

复用：不同的应用层应用可以使用同一个传输层来服务

分用：传输层可以将接收到的信息交给不同的应用——接口

## 一、TCP

### 1. 三次握手和四次挥手

#### 三次握手

- 客户端A向服务端B发送请求，请求建立连接，标志位SYN = 1
- 服务端B收到请求，分配资源和缓存，发送同意报文，标志位SYN = 1， ACK = 1

> 可能受到洪泛攻击

- 客户端A接收报文，分配资源和缓存，发送确认报文，标志位ACK = 1

#### 为什么要回传SYN和ACK

- SYN，ACK相当于身份标识，SYN是为了确保B响应的是A发送的请求（证明A的发送功能和B的接收功能无误）
- ACK是为了确保A接收的是B发送的同意报文。(证明A的接收功能和B的发送功能无误)

#### 为什么不是两次握手

- 考虑，A发送请求连接报文m，由于网络原因，m没有按时到B，A没有接收到同意报文，A重新发送n
- n正常到B，然后二者建立连接，释放连接。
- 此时m突然到B，B分配资源缓存，发送同意报文给A。
- 如果是两次握手，A连接已关闭则不予理睬，B空耗时间和资源。
- 如果是三次握手，B等不到A的确认报文，则释放资源和缓存。

#### 四次挥手

- A和B任何一方都可以主动发起断开连接请求
- A数据发送完毕，向B发送断开连接请求，标志位FIN = 1
- B收到，发送确认收到，A -> B的连接断开，标志位ACK = 1
- B数据发送完毕后，发送断开连接请求，标志位FIN = 1
- A收到后，发送确认收到，标志位ACK = 1，2MSL(2倍的最长报文寿命)后B -> A连接断开

#### 为什么要等待2MSL

- 若B未收到A发送的确认收到报文，则会尝试重新发送。
- 如果不等，直接关闭，A收到B的报文不予理睬，B资源缓存得不到释放

### 2. 如何保证可靠传输

- 将数据切分为大小合适的块，并且为每一块编号

#### 超时重传

- 每发送一个报文就维持一个计时器，如果规定时间没有收到确认报文，则重传

#### 确认应答

- 每个发送出去的报文都必须返回一个确认报文，编号为3的确认报文，代表1，2，3都传输成功

#### 流量控制（针对一条连接）

- 基于滑动窗口实现，接收方返回确认报文，首部可以携带自己还能接受的数据量的信息
- 发送方根据这个信息动态调整发送窗口大小

#### 拥塞控制（针对整个网络状态）

- 拥塞窗口是发送窗口的大小
- 慢开始：每收到一个确认报文，则拥塞窗口 + 1， 指数增长
- 拥塞避免：增长到一个阈值后，开始线性增长，每经过一个往返时延，拥塞窗口 +1
- 出现**超时**：阈值变为当前拥塞窗口的一半，拥塞窗口置位1
- 出现**冗余ACK**：**快重传**：3个冗余ACK则重传目标报文。快恢复**：重传后，阈值变为当前拥塞窗口一半，拥塞窗口也减半（而不是变成1）。

> 冗余ACK，应该受到2号报文，但是收到了3号，则发送一个冗余ACK给发送方

## 二、TCP和UDP异同

- TCP面向连接，先建立连接再传输数据，保证可靠交付，UDP无连接，不保证可靠交付

> TCP适用于文件传输，邮件，UDP适用于要求延时小的地方，直播，语音通话

- TCP面向字节流，对于应用层传递来的数据，进行拆分封装，UDP面向报文，对于应用层传递来的数据，只封装不拆分
- TCP只支持一对一全双工通信，UDP支持一对多，多对多
- TCP有拥塞控制，UDP没有，即使网络拥塞也不降低发送速率，实时性好，有丢包风险
- TCP首部开销大 20字节，UDP首部开销小 8字节

# 网络层

## 一、协议

### 1. ARP 地址解析协议

作用：将IP地址解析为MAC地址

过程：

- 在主机上查缓存，查IP和MAC地址的对应关系
- 没有就广播ARP分组请求，会有路由器或者主机响应
- 响应中携带对应关系或者是下一个路由器的IP地址

ARP攻击：

- 响应的IP和MAC可能是伪造的